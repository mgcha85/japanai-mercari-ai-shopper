version: "3.9"

services:
  api:
    build:
      context: ..
      dockerfile: docker/app.Dockerfile
    image: mercari-ai-shopper:latest
    container_name: mercari_api
    env_file:
      - ../.env
    environment:
      - APP_ENV=\${APP_ENV}
      - PORT=\${PORT}
      - LLM_PROVIDER=\${LLM_PROVIDER}
      - OPENAI_API_KEY=\${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=\${ANTHROPIC_API_KEY}
      - MERCARI_BASE_URL=\${MERCARI_BASE_URL}
      - USER_AGENT=\${USER_AGENT}
      - ACCEPT_LANGUAGE=\${ACCEPT_LANGUAGE}
      - HTTP_TIMEOUT=\${HTTP_TIMEOUT}
      - HTTP_MAX_RETRIES=\${HTTP_MAX_RETRIES}
      - HTTP_BACKOFF_SECONDS=\${HTTP_BACKOFF_SECONDS}
      - CACHE_DIR=\${CACHE_DIR}
      - REQUESTS_CACHE_EXPIRE_SECONDS=\${REQUESTS_CACHE_EXPIRE_SECONDS}
      - PLAYWRIGHT_BROWSERS_PATH=\${PLAYWRIGHT_BROWSERS_PATH}
      - PLAYWRIGHT_HEADLESS=\${PLAYWRIGHT_HEADLESS}
      - HTTP_PROXY=\${HTTP_PROXY}
      - HTTPS_PROXY=\${HTTPS_PROXY}
      - NO_PROXY=\${NO_PROXY}
    ports:
      - "${PORT}:${PORT}"
    volumes:
      - ../data:/app/data
    command: >
      uvicorn mercari_ai_shopper.server:app
      --host 0.0.0.0 --port \${PORT} --workers 2
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:${PORT}/health || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 20s

  cli:
    image: mercari-ai-shopper:latest
    container_name: mercari_cli
    env_file:
      - ../.env
    environment:
      - APP_ENV=\${APP_ENV}
      - LLM_PROVIDER=\${LLM_PROVIDER}
      - OPENAI_API_KEY=\${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=\${ANTHROPIC_API_KEY}
      - CACHE_DIR=\${CACHE_DIR}
      - PLAYWRIGHT_BROWSERS_PATH=\${PLAYWRIGHT_BROWSERS_PATH}
      - PLAYWRIGHT_HEADLESS=\${PLAYWRIGHT_HEADLESS}
    volumes:
      - ../data:/app/data
    working_dir: /app
    entrypoint: ["python", "-m", "mercari_ai_shopper.run"]
    profiles: ["cli"]

  tests:
    image: mercari-ai-shopper:latest
    container_name: mercari_tests
    env_file:
      - ../.env
    environment:
      - APP_ENV=test
      - CACHE_DIR=\${CACHE_DIR}
    volumes:
      - ../data:/app/data
      - ../tests:/app/tests
      - ../src:/app/src
    command: ["pytest", "-q", "--disable-warnings"]
    profiles: ["dev"]

  lint:
    image: mercari-ai-shopper:latest
    container_name: mercari_lint
    volumes:
      - ../src:/app/src
    command: ["bash", "-lc", "ruff check src && black --check src"]
    profiles: ["dev"]