services:
  api:
    build:
      context: ..
      dockerfile: docker/app.Dockerfile
    image: mercari-ai-shopper:latest
    container_name: mercari_api
    env_file:
      - ../.env
    environment:
      - APP_ENV=${APP_ENV:-dev}
      - PORT=${PORT:-8000}
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - MERCARI_BASE_URL=${MERCARI_BASE_URL:-https://jp.mercari.com/search}
      - USER_AGENT=${USER_AGENT:-Mozilla/5.0}
      - ACCEPT_LANGUAGE=${ACCEPT_LANGUAGE:-ja-JP,ja;q=0.9,en-US;q=0.8,en;q=0.7}
      - HTTP_TIMEOUT=${HTTP_TIMEOUT:-15}
      - HTTP_MAX_RETRIES=${HTTP_MAX_RETRIES:-3}
      - HTTP_BACKOFF_SECONDS=${HTTP_BACKOFF_SECONDS:-0.5}
      - CACHE_DIR=${CACHE_DIR:-/app/data/cache}
      - REQUESTS_CACHE_EXPIRE_SECONDS=${REQUESTS_CACHE_EXPIRE_SECONDS:-3600}
      - PLAYWRIGHT_BROWSERS_PATH=${PLAYWRIGHT_BROWSERS_PATH:-/ms-playwright}
      - PLAYWRIGHT_HEADLESS=${PLAYWRIGHT_HEADLESS:-true}
      - HTTP_PROXY=${HTTP_PROXY:-}
      - HTTPS_PROXY=${HTTPS_PROXY:-}
      - NO_PROXY=${NO_PROXY:-localhost,127.0.0.1}
    ports:
      - "${PORT:-8000}:${PORT:-8000}"
    volumes:
      - ../data:/app/data
    command: >
      uvicorn mercari_ai_shopper.server:app
      --host 0.0.0.0 --port ${PORT:-8000} --workers 2
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:${PORT:-8000}/health || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 20s

  cli:
    image: mercari-ai-shopper:latest
    container_name: mercari_cli
    env_file:
      - ../.env
    environment:
      - APP_ENV=${APP_ENV:-dev}
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - CACHE_DIR=${CACHE_DIR:-/app/data/cache}
      - PLAYWRIGHT_BROWSERS_PATH=${PLAYWRIGHT_BROWSERS_PATH:-/ms-playwright}
      - PLAYWRIGHT_HEADLESS=${PLAYWRIGHT_HEADLESS:-true}
    volumes:
      - ../data:/app/data
    working_dir: /app
    entrypoint: ["python", "-m", "mercari_ai_shopper.run"]
    profiles: ["cli"]

  tests:
    image: mercari-ai-shopper:latest
    container_name: mercari_tests
    env_file:
      - ../.env
    environment:
      - APP_ENV=test
      - CACHE_DIR=${CACHE_DIR:-/app/data/cache}
    volumes:
      - ../data:/app/data
      - ../tests:/app/tests
      - ../src:/app/src
    command: ["pytest", "-q", "--disable-warnings"]
    profiles: ["dev"]

  lint:
    image: mercari-ai-shopper:latest
    container_name: mercari_lint
    volumes:
      - ../src:/app/src
    command: ["bash", "-lc", "ruff check src && black --check src"]
    profiles: ["dev"]
